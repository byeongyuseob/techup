global
    daemon
    log stdout local0

resolvers docker
    nameserver dns 127.0.0.11:53
    resolve_retries 3
    timeout retry 1s
    hold valid 10s

defaults
    mode http
    log global
    option httplog
    option dontlognull
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

frontend web_frontend
    bind *:80
    stats enable
    stats uri /haproxy-stats
    stats realm HAProxy\ Statistics
    stats auth admin:admin123
    default_backend web_servers

frontend prometheus_stats
    bind *:8404
    http-request use-service prometheus-exporter if { path /metrics }
    stats enable
    stats uri /stats
    stats refresh 30s

backend web_servers
    balance roundrobin
    option httpchk GET /

    # Dynamic servers using DNS service discovery
    server-template nginx 10 nginx-backend:80 check resolvers docker init-addr none

